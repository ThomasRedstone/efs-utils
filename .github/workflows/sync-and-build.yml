name: Build Upstream Master

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight
  workflow_dispatch:

jobs:
  build-master:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libssl-dev pkg-config gettext cargo cmake clang jq

      - name: Checkout upstream master
        run: |
          git remote add upstream https://github.com/aws/efs-utils.git
          git fetch upstream master
          git checkout upstream/master

      - name: Generate Version
        id: vars
        run: |
          # Generate a version based on date to ensure uniqueness for master builds
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          VERSION="master-$TIMESTAMP"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Update build script version
        run: |
          sed -i "s/^VERSION=.*/VERSION=${{ env.VERSION }}/" build-deb.sh

      - name: Build DEB package
        run: ./build-deb.sh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.VERSION }}
          name: Master Build ${{ env.VERSION }}
          files: build/*.deb
          body: |
            Automated build from upstream master branch.
            Upstream: https://github.com/aws/efs-utils/tree/master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}